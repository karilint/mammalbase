{% extends "mb/base_generic.html" %}

{% block title %}
<title>MammalBase - Match Tool</title>
{% endblock %}

{% block content %} {% load custom_tags %}
<!--Article header -->
<header style="display:none">
  <h1>MammalBase - Trait Match Tool</h1>
</header>
<!--End of article header -->
<section class="w3-threequarter w3-container">
  <header class="w3-container w3-text-teal">
    <h2>Trait Match Tool</h2>
  </header>

  <div class="w3-container" style=" background-color: #f0f0f0; margin-bottom: 10px;">
    <p>The trait match tool allows to match unmatched source attributes to a suitable master attribute.</p>
    <p>The match tool presents one source attribute at a time and suggests the closest matching master attribute.
       The suggestion can then be accepted or skipped.</p>
  </div>
    {% include 'includes/find.html' %}
    {% if page_obj %}
      {% if user.is_authenticated %}
        <br>
      {% else %}
        <br>
      {% endif %}
      <table class="mb-list w3-table-all w3-small w3-responsive">
        <thead>
          <tr>
            <th style="width: 33%;">Source Trait</th>
            <th style="width: 25%;">Suggested Standard Trait</th>
            <th style="width: 33%;">Reference</th>
            <th style="width: 10%;"></th>
          </tr>
        </thead>
        <tbody>
            {% for x in page_obj %}
            <tr>
                <td class="mb-public-internal">
                    <a title="Press for Details" href="{% url 'source_attribute-detail' pk=x.pk %}">{{ x.name }} <span class="fa fa-link w3-small"></span></a>
                </td>
                <td>
                  <select name="master_attribute" class="w3-select">
                      {% for master_attribute in master_attributes %}
                          {% if x.matched_master %}
                              {% if x.matched_master.id == master_attribute.id %}
                                  <option value="{{ master_attribute.id }}" selected>{{ master_attribute.name }}</option>
                              {% else %}
                                  <option value="{{ master_attribute.id }}">{{ master_attribute.name }}</option>
                              {% endif %}
                          {% else %}
                              <option value="{{ master_attribute.id }}">{{ master_attribute.name }}</option>
                          {% endif %}
                      {% endfor %}
                  </select>
              </td> 
              <td>{{ x.reference}}</td>
                <td><button id="matchButton_{{ x.pk }}" title="Press to match the source attribute" type="button" class="w3-button w3-medium w3-round w3-padding-small w3-teal">
                    Match&nbsp;<i class="fa fa-angle-right"></i>
                </button></td>
            </tr>
            {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No matches found.</p>
    {% endif %}
</section>
{% endblock %}
{% block info %}
{% endblock %}
{% block pagination %}
  {% include 'mb/pagination.html' %}
{% endblock %}
{% block script %}
<script>
    function handleMatchButtonClick(sourceAttributeId) {
      $.ajax({
        url: "{% url 'match_operation_endpoint' %}",
        method: "POST",
        data: {
          source_attribute_id: sourceAttributeId,
          csrfmiddlewaretoken: "{{ csrf_token }}"
        },
        success: function(data) {
          alert("Match successful!");
          location.reload();
        },
        error: function(xhr, status, error) {
          console.error("Error:", error);
          alert("An error occurred while matching.");
        }
      });
    }
    
    $(document).ready(function() {
      $("button[id^='matchButton_']").click(function() {
        var sourceAttributeId = $(this).attr("id").split("_")[1];
        handleMatchButtonClick(sourceAttributeId);
      });
    });
  </script>
{% endblock %}
