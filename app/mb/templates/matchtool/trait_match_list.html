{% extends "mb/base_generic.html" %}

{% block title %}
<title>MammalBase - Match Tool</title>
{% endblock %}

{% block content %} {% load custom_tags %}
<!--Article header -->
<header style="display:none">
  <h1>MammalBase - Trait Match Tool</h1>
</header>
<!--End of article header -->
<section class="w3-threequarter w3-container">
  <header class="w3-container w3-text-teal">
    <h2>Trait Match Tool</h2>
  </header>

    <div id="message-container"></div>

    {% include 'includes/find.html' %}
    {% if page_obj %}
      <br>
      <table class="mb-list w3-table-all w3-small w3-responsive">
        <thead>
          <tr>
            <th style="width: 30%;">Source Trait</th>
            <th style="width: 5%;"></th>
            <th style="width: 30%;">Suggested Standard Trait</th>
            <th style="width: 30%;">Reference</th>
            <th style="width: 5%;"></th>
          </tr>
        </thead>
        <tbody>
            {% for x in page_obj %}
            <tr>
              <td class="mb-public-internal source-attribute-name">
                <a title="Press for Details" href="{% url 'source_attribute-detail' pk=x.pk %}">
                  <span>{{ x.name }}</span><span class="fa fa-link w3-small"></span></a>  
              </td>
              <td>
                <button id="editButton_{{ x.pk }}" title="Modify the source attribute" type="button" 
                  class="w3-button w3-medium w3-round w3-padding-small w3-gray w3-text-white">
                  Modify&nbsp;
                </button>
              </td>
              <td>
                <select name="master_attribute" class="w3-select">
                  {% for master_attribute in master_attributes %}
                    {% if x.matched_master %}
                      {% if x.matched_master.id == master_attribute.id %}
                        <option value="{{ master_attribute.id }}" selected>{{ master_attribute.name }}</option>
                      {% else %}
                        <option value="{{ master_attribute.id }}">{{ master_attribute.name }}</option>
                      {% endif %}
                    {% else %}
                      <option value="{{ master_attribute.id }}">{{ master_attribute.name }}</option>
                    {% endif %}
                  {% endfor %}
                </select>
              </td> 
              <td>{{ x.reference}}</td>
              <td>
                <button id="matchButton_{{ x.pk }}" title="Press to match the source attribute" type="button"
                  class="w3-button w3-medium w3-round w3-padding-small w3-teal">
                  Match&nbsp;<i class="fa fa-angle-right"></i>
                </button>
              </td>
            </tr>
            {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No matches found.</p>
    {% endif %}
</section>
{% endblock %}
{% block info %}
{% endblock %}
{% block pagination %}
  {% include 'mb/pagination.html' %}
{% endblock %}
{% block script %}
<script>
  $(document).ready(function() {
    $("button[id^='matchButton_']").click(function() {
      var sourceAttributeId = $(this).attr("id").split("_")[1];
      var selectedMasterAttributeId = $(this).closest("tr").find("select[name='master_attribute']").val();
      handleMatchButtonClick(sourceAttributeId, selectedMasterAttributeId);
    });

    $("button[id^='editButton_']").click(function() {
        var sourceAttributeId = $(this).attr("id").split("_")[1];
        handleEditButtonClick(sourceAttributeId);
    });
  });

  function handleMatchButtonClick(sourceAttributeId, selectedMasterAttributeId) {
    $.ajax({
      url: "{% url 'match_operation_endpoint' %}",
      method: "POST",
      data: {
        source_attribute_id: sourceAttributeId,
        selected_master_attribute_id: selectedMasterAttributeId,
        csrfmiddlewaretoken: "{{ csrf_token }}"
      },
      success: function(data) {
        if (data.success) {
          $("#message-container").html("<p class='success-message'>Match successful!</p>");
          location.reload();
        } else {
          $("#message-container").html("<p class='error-message'>Match failed: </p>" + data.error);
        }
      },
      error: function(xhr, status, error) {
        $("#message-container").html("<p class='error-message'>An error occurred while matching.</p>");
        setTimeout(function() {
          $("#message-container").empty();
        }, 4000);
      }
      });
    }

  function handleEditButtonClick(sourceAttributeId) {
    let newName = prompt("Edit the name", "Modified source attribute name");
    if (newName !== null && newName !== "") {
      $.ajax({
        url: "{% url 'source_attribute_edit' %}",
        method: "POST",
        data: {
          source_attribute_id: sourceAttributeId,
          new_name: newName,
          csrfmiddlewaretoken: "{{ csrf_token }}"
        },
        success: function(data) {
          $("#message-container").html("<p class='success-message'>Name changed successfully!</p>");
          setTimeout(function() {
            $("#message-container").empty();
          }, 4000);

          var sourceAttributeId = data.source_attribute_id;
          var newName = data.new_name;
          $("#editButton_" + sourceAttributeId).closest("tr").find(".source-attribute-name").text(newName);
        },
        error: function(xhr, status, error) {
          $("#message-container").html("<p class='error-message'>An error occurred while editing.</p>");
          setTimeout(function() {
            $("#message-container").empty();
          }, 4000);
        }
      });
    }
  }
</script>
{% endblock %}
