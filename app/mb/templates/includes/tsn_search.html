<table class="mb-form w3-table-all">
    <tr>
        <th class="w3-twoquarter">Search TSN from ITIS</th>
        <td class="w3-twoquarter">
            <input id="itis-search-bar" type="text" placeholder="Search...">
        </td>
    </tr>
</table>
<div class="mb-detail w3-bar w3-right-align">
    <button class="w3-button w3-tiny w3-round w3-padding-small w3-teal" onclick="get_tsn()">Search&nbsp; <i class="fa fa-angle-right"></i><i class="fa fa-angle-right"></i></button>
</div>
<div class="w3-container w3-text-teal">
    <h2 id="itis-list-header"></h2>
</div>
<div id="tsn-table-container">
    <table class="mb-form w3-table-all" id="itis-list">

    </table>
</div>
  
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
<script>
    var page = 0
    function get_tsn(){
        query=document.getElementById('itis-search-bar').value;
        $.ajax({
            url: '{% url "tsn-search" %}',
            type: 'POST',
            data: {
                csrfmiddlewaretoken: "{{ csrf_token }}",
                query:query
            },
            success: function (res) {
                
                create_tsn_table(res,page*10)
                next = document.createElement("button");
                next.classList.add("w3-button", "w3-tiny", "w3-round", "w3-padding-small", "w3-teal", "w3-margin")
                next.onclick = function() {
                    if ((page+1)*10<Object.keys(res).length) {
                        page+=1;
                        create_tsn_table(res);
                    }
                }
                next.innerHTML="Next page";
                
                previous = document.createElement("button");
                previous.classList.add("w3-button", "w3-tiny", "w3-round", "w3-padding-small", "w3-teal", "w3-margin")
                previous.onclick = function() {
                    if ((page-1)*10>=0) {
                        page-=1;
                        create_tsn_table(res);
                    }
                }
                previous.innerHTML="Previous page";
                document.getElementById("tsn-table-container").appendChild(previous);
                document.getElementById("tsn-table-container").appendChild(next);
            }
        }); 
    }
    function create_tsn_table(res) {
        let list = document.getElementById("itis-list");
        list.innerHTML = "";
        document.getElementById("itis-list-header").innerHTML=res["message"]
        start = page*10;
        for (const [key, value] of Object.entries(res).slice(start,start+10)) {
            if (key == "message") continue;
            let row = create_tsn_row();
            let name = create_tsn_name(value["scientificName"]);
            let tsn = create_tsn_value(key);
            let select_button = create_tsn_select_button(key);
            row.appendChild(name);
            row.appendChild(tsn);
            row.appendChild(select_button);
            list.appendChild(row);
        }
    }
    function create_tsn_row() {
        let row = document.createElement("tr");
        row.classList.add("w3-row");
        return row;
    }
    function create_tsn_name(name) {
        let name_container = document.createElement("div");
        name_container.classList.add("w3-half");

        let name_header = document.createElement("th");
        name_header.classList.add("w3-third");
        name_header.appendChild(document.createTextNode("Scientific name:"));
        name_container.appendChild(name_header);

        let name_value = document.createElement("td");
        name_value.classList.add("w3-twothird");
        name_value.appendChild(document.createTextNode(name));
        name_container.appendChild(name_value);
        return name_container;
    }
    function create_tsn_value(tsn) {
        let tsn_container = document.createElement("div");
        tsn_container.classList.add("w3-third")
        

        let tsn_header = document.createElement("th");
        tsn_header.classList.add("w3-quarter");
        tsn_header.appendChild(document.createTextNode("Tsn:"));
        tsn_container.appendChild(tsn_header);

        let tsn_link = document.createElement("a");
        tsn_link.classList.add("btn", "btn-default");
        tsn_link.href = `https://www.itis.gov/servlet/SingleRpt/SingleRpt?search_topic=TSN&search_value=${tsn}#null`;
        tsn_link.target="_blank";
        tsn_link.appendChild(document.createTextNode(tsn));
        let tsn_span = document.createElement("span");
        tsn_span.classList.add("fa", "fa-external-link");
        tsn_link.appendChild(tsn_span);
        
        let tsn_value = document.createElement("td");
        tsn_value.classList.add("w3-quarter");
        tsn_value.appendChild(tsn_link);
        tsn_container.appendChild(tsn_value);
        return tsn_container;
    }
    function create_tsn_select_button(tsn) {
        let select_button = document.createElement("button");
        select_button.innerHTML="Select&nbsp;";
        select_button.onclick=function() {select_tsn(tsn)};
        select_button.classList.add("w3-button", "w3-tiny", "w3-round", "w3-padding-small", "w3-teal", "w3-margin", "w3-rest");
        let select_button_i = document.createElement("i");
        select_button_i.classList.add("fa","fa-angle-right");
        select_button.appendChild(select_button_i);
        select_button.appendChild(select_button_i.cloneNode(true));
        return select_button;
    }
    function select_tsn(tsn) {
        console.log(tsn)
    }
</script>